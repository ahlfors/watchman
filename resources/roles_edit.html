<div id="roles-edit-page">
  <script type="text/javascript">
    $(document).ready(function() {
      // If it's a new role, focus the name input box.
      if ($("input[name=name]").val() == "")
        $("input[name=name]").focus();
      var currentRowIndex = 10000;

      var removeRow = function(event) {
        event.preventDefault();
        row = $(event.target).parents("tr");
        row.find("input.deleted").val("true");
        row.hide();
      };

      var addRow = function(event) {
        event.preventDefault();
        var clickedTableRow = $(event.target).parents("tr");
        var newRow = clickedTableRow.parents("table").find(".row-template").clone();
        newRow.removeClass("row-template");
        newRow.attr("style", null);
        newRow.find(".deleted").val("false");
        var rowIndex = currentRowIndex++;
        newRow.find("input").each(function(i, input) {
          input = $(input);
          // We're trying to match check[0][hey].
          var match = input.attr("name").match(/(.+)\[.+\]\[(.+)\]/);
          var newName = match[1] + "[" + rowIndex + "][" + match[2] + "]";
          input.attr("name", newName);
        });
        newRow.insertBefore(clickedTableRow);
        newRow.find("input:visible").first().focus();
      };


      $("#roles-edit-page").on("click", "a.add", addRow);

      $("#roles-edit-page").on("click", "a.remove", removeRow);
    });
  </script>

  <form method="POST">

    <p>
      Role name
      <input type="text" name="name" />
    </p>

    <h2>Checks</h2>
    <table id="checks" class="display">
      <tr>
        <th>Path</th>
        <th>Nickname</th>
        <th>HTTP status code</th>
        <th>Timeout</th>
        <th>Max retries</th>
        <th></th>
      </tr>

      <!-- This is an HTML fragment that the javascript clones when adding a new row via the Add button.  Note
           that these input fields get submitted with the form, so it's important that the "deleted" flag is
           set to true in the HTML, so these fields are not persisted during submission. -->
      <tr class="row-template" style="display:none">
        <td>
          <input type="hidden" class="id" name="checks[0][id]"/>
          <input type="hidden" class="deleted" name="checks[0][deleted]" value="true"/>
          <input type="text" class="path" name="checks[0][path]"/>
        </td>
        <td><input type="text" class="nickname" name="checks[0][nickname]"/></td>
        <td>
          <input type="text" class="expected-status-code" name="checks[0][expected_status_code]" value="200"/>
        </td>
        <td><input type="text" class="timeout" name="checks[0][timeout]" value="3"/></td>
        <td><input type="text" class="max-retries" name="checks[0][max_retries]" value="0"/></td>
        <td><a href="#" class="remove"><i class="icon-remove"></i></a></td>
      </tr>

      <tr class="check">
        <td>
          <input type="hidden" class="id" name="checks[0][id]"/>
          <input type="hidden" class="deleted" name="checks[0][deleted]" value="false"/>
          <input type="text" class="path" name="checks[0][path]"/>
        </td>
        <td><input type="text" class="nickname" name="checks[0][nickname]"/></td>
        <td><input type="text" class="expected-status-code" name="checks[0][expected_status_code]"/></td>
        <td><input type="text" class="timeout" name="checks[0][timeout]"/></td>
        <td><input type="text" class="max-retries" name="checks[0][max_retries]"/></td>
        <td><a href="#" class="remove"><i class="icon-remove"></i></a></td>
      </tr>
      <tr>
        <td colspan=5></td>
        <td><a href="#" class="add"><i class="icon-plus"></i></a></td>
      </tr>
    </table>

    <h2>Hosts</h2>
    <table id="hosts" class="display">
      <tr>
        <th>Hostname <span class="example">e.g. server1.example.com</span></th>
        <th></th>
      </tr>
      <tr class="row-template" style="display:none">
        <td>
          <input type="hidden" class="id" name="hosts[0][id]"/>
          <input type="hidden" class="deleted" name="hosts[0][deleted]" value="true"/>
          <input type="text" class="hostname" name="hosts[0][hostname]"/>
        </td>
        <td><a href="#" class="remove"><i class="icon-remove"></i></a></td>
      </tr>
      <tr class="host">
        <td>
          <input type="hidden" class="id" name="hosts[0][id]"/>
          <input type="hidden" class="deleted" name="hosts[0][deleted]" value="false"/>
          <input type="text" class="hostname" name="hosts[0][hostname]"/>
        </td>
        <td><a href="#" class="remove"><i class="icon-remove"></i></a></td>
      </tr>
      <tr>
        <td></td>
        <td><a href="#" class="add"><i class="icon-plus"></i></a></td>
      </tr>
    </table>
    <input type="submit" name="submit" value="Save" />
  </form>
</div>
